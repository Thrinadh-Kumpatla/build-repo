version: 0.2
env:
  parameter-store:
    ssh_key: "build-deploy-github-key"
    GITHUB_TOKEN: "build-deploy-pkey"
phases:
  install:
    commands:
      - wget https://github.com/mikefarah/yq/releases/download/v4.9.6/yq_linux_amd64 -O /usr/bin/yq
      - chmod +x /usr/bin/yq
      - apt update
      - apt install -y git
      - apt update 
      - wget https://github.com/github/hub/releases/download/v2.14.2/hub-linux-amd64-2.14.2.tgz
      - tar -xvzf hub-linux-amd64-2.14.2.tgz
      - mkdir /usr/bin/hub
      - mv hub-linux-amd64-2.14.2 /usr/bin/hub
      - chmod +x /usr/bin/hub
  build:
    commands:
      - export GITHUB_TOKEN="$GITHUB_TOKEN"
      - mkdir -p ~/.ssh
      - echo "$ssh_key"
      - echo "$ssh_key" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - eval "$(ssh-agent -s)"
      - VERSION=`yq e '.spec.containers[0].env[0].version' test.yaml`
      - yes | git clone git@github.com:Thrinadh-Kumpatla/deploy-repo.git
      - git remote -v
      - cd deploy-repo
      - git remote -v
      - git config --global user.email "kthrinadh8898@gmail.com"
      - git config --global user.name "Thrinadh-Kumpatla"
      - git checkout "version-change-branch-23"
      - yq eval ".spec.containers[0].env[0].version=\"$VERSION\"" deploy.yaml >> deploy.yaml
      - cat deploy.yaml
      - git add .
      - git commit -m "changing version"
      - git push -u origin version-change-branch-23
      - hub pull-request -m "PR for version change-23"
